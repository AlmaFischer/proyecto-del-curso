<div id="app"></div>

<script>
  // Esperamos a que el DOM esté completamente cargado
  document.addEventListener("DOMContentLoaded", () => {

    // Accedemos a lit-html expuesto globalmente en window.litHtml
    const { html, render } = window.litHtml;
    const appContainer = document.getElementById('app');

    // Estado de la aplicación: mensajes y resultados de cada prueba.
    const state = {
      uploadMessage: '',
      downloadMessage: '',
      filesList: null,
    };

    // Plantilla principal con secciones para probar cada endpoint.
    const template = (state) => html`
      <div class="container">
        <!-- Título general -->
        <div class="row mb-4">
          <div class="col">
            <label class="form-label fs-2">DocLocker - Home | API Test Page</label>
          </div>
        </div>

        <!-- Sección para probar POST /upload -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card shadow-sm">
              <div class="card-header bg-primary text-white">
                <label class="mb-0">Subir Archivo (POST /upload)</label>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <input id="upload-file" type="file" class="form-control" />
                </div>
                <div class="d-grid">
                  <button @click=${uploadFile} class="btn btn-primary">Subir Archivo</button>
                </div>
                ${state.uploadMessage 
                  ? html`<div class="mt-2 alert alert-info">${state.uploadMessage}</div>` 
                  : ''}
              </div>
            </div>
          </div>
        </div>

        <!-- Sección para probar GET /download/:filename -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card shadow-sm">
              <div class="card-header bg-success text-white">
                <label class="mb-0">Descargar Archivo (GET /download/:filename)</label>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <input id="download-filename" type="text" placeholder="Nombre del archivo" class="form-control" />
                </div>
                <div class="d-grid">
                  <button @click=${downloadFile} class="btn btn-success">Descargar Archivo</button>
                </div>
                ${state.downloadMessage 
                  ? html`<div class="mt-2 alert alert-info">${state.downloadMessage}</div>` 
                  : ''}
              </div>
            </div>
          </div>
        </div>

        <!-- Sección para probar GET /files -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card shadow-sm">
              <div class="card-header bg-secondary text-white">
                <label class="mb-0">Listar Archivos (GET /files)</label>
              </div>
              <div class="card-body">
                <div class="d-grid mb-3">
                  <button @click=${listFiles} class="btn btn-secondary">Listar Archivos</button>
                </div>
                <div>
                  ${state.filesList 
                    ? html`
                        <ul class="list-group">
                          ${state.filesList.map(file => html`<li class="list-group-item">${file}</li>`)}
                        </ul>
                      `
                    : html`<div class="alert alert-secondary">No hay archivos listados.</div>`
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    // Función para actualizar la vista
    function update() {
      render(template(state), appContainer);
    }

    // Función para manejar la subida de archivos
    async function uploadFile() {
      const fileInput = document.getElementById('upload-file');
      const file = fileInput.files[0];
      if (!file) {
        state.uploadMessage = 'Por favor, seleccione un archivo.';
        return update();
      }
      const formData = new FormData();
      formData.append('file', file);
      try {
        const response = await axios.post('/upload', formData, {
          headers: { 'Content-Type': 'multipart/form-data' }
        });
        state.uploadMessage = response.data.success
          ? `Archivo "${response.data.file}" subido correctamente.`
          : 'Error al subir el archivo.';
      } catch (error) {
        state.uploadMessage = `Error: ${error.response ? error.response.data.error : error.message}`;
      }
      update();
    }

    // Función para manejar la descarga de un archivo
    function downloadFile() {
      const filename = document.getElementById('download-filename').value.trim();
      if (!filename) {
        state.downloadMessage = 'Ingrese el nombre del archivo a descargar.';
        update();
        return;
      }
      // Redirigimos a la URL de descarga
      window.location.href = `/download/${encodeURIComponent(filename)}`;
    }

    // Función para listar archivos disponibles
    async function listFiles() {
      try {
        const response = await axios.get('/files');
        if (response.data.success) {
          state.filesList = response.data.files;
        } else {
          state.filesList = [];
        }
      } catch (error) {
        state.filesList = [];
        state.uploadMessage = `Error: ${error.response ? error.response.data.error : error.message}`;
      }
      update();
    }

    // Inicializar la vista
    update();
  });
</script>
